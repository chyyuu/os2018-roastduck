# Lab 3 Report

## 练习1

调用在Lab2实现的`get_pte`函数创建或获取线性地址对应的页表项，若此表项没有被映射到任何一个物理页，则调用`pgdir_alloc_page`函数为其分配一个。值得注意的是，若页表项的存在位为零，并不一定意味着此表项没有对应的物理页，因为它的物理页可能被交换到外存了。只有页表项各个位全为零，才意味着需要为其分配一个新的物理页。

### 请描述页目录项（Pag Director Entry）和页表（Page Table Entry）中组成部分对ucore实现页替换算法的潜在用处

存在位为1时，说明此表项在内存中有对应的物理页或次级页表，表项的结构需与x86要求的一致，即其中低7位是各种标志位，高20位表示页或者次级页表的地址。这些标志位中与替换算法直接相关的有：

- 第5位表示已访问。硬件一旦访问某一表项，就会将其已访问位置1。操作系统可以定期检查此位，并在检查后将此位清零，即可统计各表项的使用频率。可以利用此统计结果，实现LFU等基于访问频率的替换算法；
- 第6位表示已写入。硬件一旦写入某表项对应的页，就会将其已写入位置1。操作系统在将某一页替换到外存时可以检查此位，若外存上已有数据，而此页若未被重新写入，则不必将此页再次写入到外存。

存在位为0时，硬件不会检查表项剩下的部分，故软件可以任意使用之。当某页表表项对应的物理页被交换到外存时，μCore使用了第8~31位记录此页被存储在外存上的位置。

### 如果ucore的缺页服务例程在执行过程中访问内存，出现了页访问异常，请问硬件要做哪些事情？

硬件无从知晓μCore正在执行的是普通过程还是缺页服务例程，所以硬件处理过程与处理一般的页访问异常无异：硬件会将访存出现异常时使用的线性地址存入CR2寄存器。然后，执行通用的异常产生流程，包括保存通用寄存器、段选择子、错误码、返回地址等。由于程序一开始就运行在内核态，所以不必切换特权级。最后通过异常/中断向量表找到异常/中断处理例程，执行该例程。

## 练习2

在`map_swappable`函数中将新标记为可置换的页添加到队列末端，在`swap_out_victim`中取出队列首端的页作为将被置换到外存的页即可。

### 如果要在ucore上实现"Extended Clock页替换算法"，请给你的设计方案。现有的`swap_manager`框架是否足以支持在ucore中实现此算法？如果是，请给你的设计方案。如果不是，请给出你的新的扩展和基此扩展的设计方案
