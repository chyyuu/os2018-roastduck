# Lab 7 Report

## 练习1

为实现内核级信号量，μCore首先为每个信号量实现了一个`wait_queue_t`队列，可通过`wait_current_set`将当前进程置为SLEEPING状态并加入队列；或通过`waitup_first`唤醒队首进程，即将此进程置为RUNNABLE状态。等待队列确保了先等待的进程先唤醒。

具体实现信号量时，`down`函数用于尝试减少信号量（P操作），若当前信号量大于零，则直接减少信号量并返回。否则说明信号量不足，此时将当前进程加入等待队列，唤出调度器执行其他RUNNABLE的进程，自己则等待其他进程尝试增加信号量时将其唤醒，唤醒后将自己移出队列。`up`函数用于尝试增加信号量（V操作），若当前队列中没有进程在等待，则直接增加信号量并返回。否则唤醒等待队列中的队首进程。操作等待队列是互斥的，否则可能发生错误，所以以上函数在操作等待队列时会关中断来实现一个临界区。

若要在用户态进程中实现信号量，可为P和V两个操作分别实现一个系统调用，在系统调用中执行上述内核的信号量函数`down`和`up`。用户态进程使用信号量时，除需要通过系统调用进入内核态而造成了更大开销以外，与内核态进程直接使用信号量没有其他不同。
