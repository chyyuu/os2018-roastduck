# Lab 4 Report

## 练习1

实现这个练习只需要初始化`proc_struct`中的成员：`state`应赋值为`PROC_UNINIT`，`pid`应赋值为-1表示未分配，`cr3`赋值为当前内核页目录表`boot_cr3`，其他值均赋值为零即可。

### 请说明`proc_struct`中`struct context context`和`struct trapframe *tf`成员变量含义和在本实验中的作用是什么

`context`用于在进程切换时保存当前进程执行的上下文，它的各个成员存储了一个进程的程序计数器`eip`、栈顶指针`esp`，和通用寄存器`ebx`、`ecx`、`edx`、`esi`、`edi`、`ebp`中的值（`ebp`按实际情况也可视作专用寄存器）。当发生切换时，μCore先保存CPU各寄存器的值到原进程的`context`，然后将新进程的`context`加载到CPU各寄存器中。由于进程切换时所有进程都位于内核态（如果用户态进程要进行切换，首先要通过异常/中断切换到内核态），所以段寄存器、页表等都不会变化，不必保存。

`tf`则用于保存一个进程在发生中断时的上下文，各成员含义如下

- `tf_regs`保存了各通用寄存器的值；
- `tf_gs`、`tf_fs`、`tf_es`、`tf_ds`、`tf_cs`、`tf_ss`保存了各段选择子的值；
- `tf_trapno`保存了中断/异常编号，`tf_err`保存了某些中断/异常的具体原因；
- `tf_eip`保存返回地址；
- `tf_eflags`保存了各标志位的值；
- `tf_padding0~5`无实际含义，仅用于将上述各成员按32位对齐。

发生中断时，硬件和μCore会将当前进程的上下文保存到`tf`中，并在从异常返回时恢复上述值。其中`tf_cs`、`tf_ss`、`tf_trapno`、`tf_err`、`tf_eip`、`tf_eflags`是由硬件负责的，`tf`的其余成员是由μCore负责的。此外，`tf_esp`和`tf_ss`仅会在用户态进程发生中断时被保存。由于用户态进程要进行切换时，首先要通过异常/中断切换到内核态，所以`tf`也间接地在本实验发挥作用。
