# Lab 2 Report

## 练习1

所涉及的四个函数改动如下：

- `default_init`：没有改动；
- `default_init_memmap`：没有改动；
- `default_alloc_pages`：此函数分两部分：遍历链表寻找足够大的块、将此块中所需部分取出并将剩余部分插入链表。前一部分原来的实现是正确的，故没有改动。后一部分原来的实现中，是将块中剩余的部分直接插入到了链表头之后，而没有维护链表中块地址的有序性，故改为将块中剩余的部分插入到此块原来所在的位置处。
- `default_free_pages`：此函数分两部分：设置被释放页的属性、将这些页插入链表。前一部分原来的实现是正确的，故没有改动。后一部分改为如下实现：首先将被释放的页作为单独一个块插入链表中相应的位置，然后尽量与其左侧邻接的块合并，再尽量与其右侧邻接的块合并。

### 你的first fit算法是否有进一步的改进空间

改进空间如下：

1. 目前`default_alloc_pages`的实现中，如果申请`n`页，而找到的块只比`n`大一点，例如`n+1`页，那么这剩下的一页也会被重新插入链表。这会使链表中形成大量碎片，影响此后遍历链表的性能。一个合理的改进是：块中剩余的页数大于某个阈值时，才将其重新插入链表；
2. 目前同一个页表的`default_init_memmap`函数只能被执行一次，即不能多次向同一个页表新增可分配空间。如果要支持被执行多次，则需在此函数中遍历链表，将新分配的块插入到链表中适当的位置上，以保证链表中地址的单调性。

## 练习2

首先根据地址的高10位找到页目录表中的目录表项，判断此表项是否已存在。若不存在且需要创建，则分配并初始化一个新页作为二级页表，并在对应的目录表项中设置二级页表的地址和权限。

### 请描述页目录项（Page Director Entry）和页表项（Page Table Entry）中每个组成部分的含义和以及对ucore而言的潜在用处

页目录表项与页表项的结构是相同的，从低位到高位，其组成如下：

- 第0位表示此表项是否存在。若此位为零，则此页不在内存中，剩下的31位不再表示原意义，但可用作其他用途。在页表第0位为零时，若此页被交换到磁盘，μCores使用剩下的位表示磁盘上存储此页的位置。
- 第1位表示此表项中的页是只读还是可写。
- 第2位表示用户态是否有权访问此表项中的页。
- 第3位表示写入此页时，是写穿（Write-through）还是写回（Write-back）。
- 第4位表示是否禁用此页的缓存。
- 第5位表示已访问。硬件一旦访问某一表项，就会将其已访问位置1。操作系统可以定期检查此位，并在检查后将此位清零，即可统计各表项的使用情况。可以利用此统计结果，实现LFU等基于访问频率的替换算法。
- 第6位表示已写入。硬件一旦写入某表项对应的页，就会将其已写入位置1。操作系统在将某一页替换到磁盘时可以检查此位，磁盘上已有数据，而此页若未被重新写入，则不必将此页再次写入到磁盘。
- 第7~8位必须为零。
- 第9~11位可供操作系统做任意用途。
- 第12~31位表示页或者次级页表的地址。

### 如果ucore执行过程中访问内存，出现了页访问异常，请问硬件要做哪些事情？


